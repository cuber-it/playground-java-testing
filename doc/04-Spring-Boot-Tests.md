# Spring Boot Tests

## Testarten im Ueberblick

```
                    Geschwindigkeit
                          ▲
                          │
    Unit-Tests ───────────┼──────────────── Schnell
    Slice-Tests ──────────┼────────────── Mittel
    Integrationstests ────┼──────────── Langsam
                          │
                          └──────────────────────>
                                      Realitaetsnähe
```

## @SpringBootTest - Volle Integration

Laedt den **kompletten** Spring-Kontext.

```java
// src/test/java/.../integration/springboot/TodoSpringBootTest.java

@SpringBootTest
@Transactional  // Rollback nach jedem Test
class TodoSpringBootTest {

    @Autowired
    private TodoService service;

    @Autowired
    private TodoRepository repository;

    @Test
    @DisplayName("Service kann Todo speichern und laden")
    void createAndFind() {
        Todo todo = service.create("Integration Test");

        Todo found = service.findById(todo.getId());

        assertThat(found.getTitle()).isEqualTo("Integration Test");
    }
}
```

**Was wurde gemacht:** Test mit echtem Service, Repository und H2-Datenbank.

**Warum:** Prueft das Zusammenspiel aller Komponenten.

## Slice-Tests - Fokussierte Tests

### @DataJpaTest - Repository-Tests

Laedt nur JPA-relevante Beans (Repository, EntityManager, DataSource).

```java
// src/test/java/.../integration/slice/TodoRepositorySliceTest.java

@DataJpaTest
class TodoRepositorySliceTest {

    @Autowired
    private TodoRepository repository;

    @Autowired
    private TestEntityManager entityManager;

    @Test
    @DisplayName("Custom Query findet Todos nach Titel")
    void findByTitleContaining() {
        entityManager.persist(createTodo("Einkaufen gehen"));
        entityManager.persist(createTodo("Sport machen"));
        entityManager.flush();

        List<Todo> found = repository.findByTitleContaining("gehen");

        assertThat(found).hasSize(1);
        assertThat(found.get(0).getTitle()).contains("gehen");
    }
}
```

**Was wurde gemacht:** Repository isoliert testen, ohne Controller/Service.

**Warum:** Schneller als @SpringBootTest, fokussiert auf Datenzugriff.

### @WebMvcTest - Controller-Tests

Laedt nur Web-Layer (Controller, Filter, WebMvcConfigurer).

```java
// src/test/java/.../integration/slice/TodoControllerSliceTest.java

@WebMvcTest(TodoRestController.class)
class TodoControllerSliceTest {

    @Autowired
    private MockMvc mockMvc;

    @MockBean  // Service wird gemockt!
    private TodoService service;

    @Test
    @DisplayName("GET /api/todos gibt Liste zurueck")
    void getAllTodos() throws Exception {
        when(service.findAll()).thenReturn(List.of(
            createTodo(1L, "Test Todo")
        ));

        mockMvc.perform(get("/api/todos"))
            .andExpect(status().isOk())
            .andExpect(jsonPath("$[0].title").value("Test Todo"));
    }
}
```

**Was wurde gemacht:** Controller isoliert testen mit gemocktem Service.

**Warum:** Schnell, testet HTTP-Mapping und JSON-Serialisierung.

## @MockBean vs @Mock

| Annotation | Verwendung | Kontext |
|------------|------------|---------|
| `@Mock` | Unit-Tests ohne Spring | Mockito |
| `@MockBean` | Spring-Tests | Spring ersetzt echte Bean |

```java
// Unit-Test (ohne Spring)
@ExtendWith(MockitoExtension.class)
class ServiceTest {
    @Mock
    private Repository repo;
}

// Spring-Test
@WebMvcTest
class ControllerTest {
    @MockBean  // Ersetzt echte Bean im Kontext
    private Service service;
}
```

## Datenbank-Tests

### H2 In-Memory (Standard)

```java
// src/test/java/.../integration/database/TodoH2Test.java

@SpringBootTest
@Transactional
class TodoH2Test {

    @Test
    void autoGeneratedId() {
        Todo saved = repository.save(createTodo("Test"));
        assertThat(saved.getId()).isNotNull();
    }
}
```

**Was wurde gemacht:** Tests mit H2-Datenbank, automatisch konfiguriert.

**Warum:** Schnell, keine externe DB noetig, isolierte Tests.

### SQLite (Optional)

```java
// src/test/java/.../integration/database/TodoSqliteTest.java

@SpringBootTest
@ActiveProfiles("sqlite")
@EnabledIfSystemProperty(named = "run.sqlite.tests", matches = "true")
class TodoSqliteTest {
    // Wie H2, aber mit SQLite
}
```

**Was wurde gemacht:** Alternative Datenbank zeigen.

**Warum:** Demonstriert Profile und bedingte Tests.

## TestRestTemplate vs MockMvc

```java
// MockMvc - kein Server gestartet
@WebMvcTest
class MockMvcTest {
    @Autowired
    MockMvc mockMvc;  // Simuliert HTTP

    void test() {
        mockMvc.perform(get("/api/todos"));
    }
}

// TestRestTemplate - echter Server
@SpringBootTest(webEnvironment = RANDOM_PORT)
class RestTemplateTest {
    @Autowired
    TestRestTemplate restTemplate;  // Echte HTTP-Requests

    void test() {
        restTemplate.getForEntity("/api/todos", String.class);
    }
}
```

## Best Practices

1. **Slice-Tests bevorzugen** wenn moeglich (schneller)
2. **@Transactional** fuer DB-Tests (automatischer Rollback)
3. **Test-Profile** fuer unterschiedliche Konfigurationen
4. **@DirtiesContext** vermeiden (langsam)
5. **Testdaten in @BeforeEach** aufsetzen, nicht teilen
